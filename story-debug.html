<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Story Debug</title>
  <link rel="preconnect" href="https://images.weserv.nl" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .row { display: grid; grid-template-columns: 160px 1fr; gap: 16px; align-items: start; }
    .avatar { width: 144px; height: 144px; border-radius: 50%; object-fit: cover; }
    .ring { position: relative; display: inline-block; }
    .ring::after { content: ""; position: absolute; inset: -6px; border-radius: 50%; border: 3px solid #ff3b3b; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: .9; } 50% { opacity: .4; } 100% { opacity: .9; } }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .box { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    .muted { color: #666; }
    .err { color: #b00020; }
    button { padding: 8px 12px; }
    input { padding: 6px 8px; width: 280px; }
  </style>
</head>
<body>
  <h1>Story Debug</h1>
  <p>Use `?id=402490649` or `?u=username` in the URL. This page pulls data from `/api/search` and shows `stories` / `stories_preview` if present.</p>

  <div style="margin-bottom: 12px;">
    <input id="idInput" type="text" placeholder="Creator ID (e.g., 402490649)" />
    <input id="userInput" type="text" placeholder="Username (e.g., coxi_foxy)" />
    <button id="loadBtn">Load</button>
  </div>

  <div id="status" class="muted">Idle</div>
  <hr />

  <div id="content"></div>

  <template id="tpl">
    <div class="row">
      <div>
        <div class="ring" data-has-story="false">
          <img class="avatar" alt="avatar" />
        </div>
      </div>
      <div>
        <h2 id="title"></h2>
        <div class="grid">
          <div class="box">
            <strong>stories</strong>
            <div id="storiesVal" class="muted"></div>
          </div>
          <div class="box">
            <strong>stories_preview</strong>
            <div id="storiesPrevVal" class="muted"></div>
          </div>
        </div>
        <div class="box" style="margin-top:12px;">
          <strong>Raw</strong>
          <pre id="raw" style="white-space:pre-wrap; word-break:break-all;">{}</pre>
        </div>
      </div>
    </div>
  </template>

  <script type="module">
    const qs = new URLSearchParams(location.search);
    const el = {
      status: document.getElementById('status'),
      content: document.getElementById('content'),
      tpl: document.getElementById('tpl'),
      idInput: document.getElementById('idInput'),
      userInput: document.getElementById('userInput'),
      loadBtn: document.getElementById('loadBtn'),
    };

    const proxyImg = (u, w=320, h=427) => `https://images.weserv.nl/?url=${encodeURIComponent(u)}&w=${w}&h=${h}&fit=cover&we&il`; 

    function setStatus(msg, isErr=false) {
      el.status.textContent = msg;
      el.status.className = isErr ? 'err' : 'muted';
    }

    async function fetchById(id) {
      const url = `/api/search?id=${encodeURIComponent(id)}&page=1&page_size=1`;
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      return Array.isArray(data) ? data[0] : (data?.[0] ?? data);
    }

    async function fetchByUser(u) {
      const url = `/api/search?q=${encodeURIComponent(u)}&page=1&page_size=1`;
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      return Array.isArray(data) ? data[0] : (data?.[0] ?? data);
    }

    function renderProfile(p) {
      el.content.innerHTML = '';
      if (!p) { setStatus('No profile found', true); return; }
      const node = el.tpl.content.cloneNode(true);
      const ring = node.querySelector('.ring');
      const avatar = node.querySelector('.avatar');
      const title = node.querySelector('#title');
      const storiesVal = node.querySelector('#storiesVal');
      const storiesPrevVal = node.querySelector('#storiesPrevVal');
      const raw = node.querySelector('#raw');

      const hasStory = !!p.stories;
      if (hasStory) ring.setAttribute('data-has-story', 'true');
      avatar.src = p.avatar ? proxyImg(p.avatar) : '/static/no-image.png';
      avatar.alt = `${p.username || p.name || 'creator'} avatar`;
      title.textContent = `${p.username || ''} ${p.name ? '— ' + p.name : ''}`.trim();
      storiesVal.textContent = p.stories ? p.stories : 'null';
      storiesPrevVal.textContent = p.stories_preview ? p.stories_preview : 'null';
      raw.textContent = JSON.stringify({id:p.id,username:p.username,name:p.name,stories:p.stories,stories_preview:p.stories_preview,hasstories:p.hasstories,canlookstory:p.canlookstory}, null, 2);

      if (hasStory) {
        ring.style.cursor = 'pointer';
        ring.title = 'Open story';
        ring.addEventListener('click', () => {
          try {
            const url = p.stories;
            const v = document.createElement('video');
            v.src = url;
            v.controls = true;
            v.autoplay = true;
            v.style.width = '100%';
            const wrap = document.createElement('div');
            wrap.className = 'box';
            wrap.style.marginTop = '12px';
            wrap.innerHTML = '<strong>Player</strong>';
            wrap.appendChild(v);
            el.content.appendChild(wrap);
          } catch (e) {
            setStatus('Failed to open story: ' + e.message, true);
          }
        });
      }

      el.content.appendChild(node);
    }

    async function load() {
      try {
        setStatus('Loading…');
        const id = (el.idInput.value || '').trim() || qs.get('id');
        const user = (el.userInput.value || '').trim() || qs.get('u');
        let p = null;
        if (id) p = await fetchById(id);
        else if (user) p = await fetchByUser(user);
        else { setStatus('Enter id or username above', true); return; }
        renderProfile(p);
        setStatus('Loaded');
      } catch (e) {
        setStatus('Error: ' + e.message, true);
      }
    }

    el.loadBtn.addEventListener('click', load);
    // Auto-load if query params present
    if (qs.get('id') || qs.get('u')) load();
  </script>
</body>
</html>
